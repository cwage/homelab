services:
  ansible:
    build:
      context: .
      dockerfile: Dockerfile
    user: "${UID}:${GID}"
    working_dir: /work
    volumes:
      - ./:/work:Z
      - ../backup:/work-backup:ro,Z
      - ../testing:/work-testing:ro,Z
    environment:
      - ANSIBLE_CONFIG=/work/ansible.cfg
      - HOME=/work
      - ANSIBLE_LOCAL_TEMP=/work/.ansible/tmp
      - USER=nonroot
      - LOGNAME=nonroot
      # OpenBao credentials (passed from root .env via --env-file)
      - BAO_ADDR=${BAO_ADDR:-}
      - BAO_TOKEN=${BAO_TOKEN:-}
      - BAO_SKIP_VERIFY=${BAO_SKIP_VERIFY:-}
    entrypoint: ""
    # Network mode so the container can reach LAN hosts directly
    network_mode: host

  tinyfugue-builder:
    build:
      context: .
      dockerfile: Dockerfile.tinyfugue-builder
      args:
        UID: "${UID}"
        GID: "${GID}"
    working_dir: /build
    volumes:
      - ./files:/files:Z
      - ./files/packages:/output:Z
    entrypoint: ""
