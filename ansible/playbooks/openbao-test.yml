---
# Test playbook for OpenBao integration
# Verifies connectivity and demonstrates secret retrieval patterns
#
# Usage:
#   export BAO_TOKEN="hvs.xxxxx"
#   make run PLAY=playbooks/openbao-test.yml
#
# Or add BAO_TOKEN to your .env file

- name: Test OpenBao connectivity and secret retrieval
  hosts: localhost
  connection: local
  gather_facts: false

  vars:
    # Use community.hashi_vault with OpenBao (API compatible)
    vault_url: "{{ openbao_addr }}"
    vault_token: "{{ openbao_token }}"
    vault_validate_certs: "{{ openbao_validate_certs }}"

  tasks:
    - name: Check BAO_TOKEN is set
      ansible.builtin.assert:
        that:
          - vault_token | length > 0
        fail_msg: |
          BAO_TOKEN environment variable is not set.
          Export it in your shell or add to .env file:
            export BAO_TOKEN="hvs.xxxxx"
        success_msg: "BAO_TOKEN is configured"

    - name: Display OpenBao connection info
      ansible.builtin.debug:
        msg:
          - "OpenBao URL: {{ vault_url }}"
          - "Validate certs: {{ vault_validate_certs }}"

    - name: Test secret retrieval (backup token)
      ansible.builtin.debug:
        msg: "Retrieved backup token: {{ secret[:8] }}..."
      vars:
        secret: "{{ lookup('community.hashi_vault.hashi_vault',
                    'secret=' ~ openbao_kv_mount ~ '/data/backup/openbao:token',
                    'url=' ~ vault_url,
                    'token=' ~ vault_token,
                    'validate_certs=' ~ vault_validate_certs) }}"
      ignore_errors: true

    - name: Show lookup pattern for playbooks
      ansible.builtin.debug:
        msg: |
          To retrieve secrets in your playbooks, use:

          vars:
            my_secret: "{{ lookup('community.hashi_vault.hashi_vault',
                          'secret=kv/data/path/to/secret:field',
                          'url=' ~ openbao_addr,
                          'token=' ~ openbao_token,
                          'validate_certs=' ~ openbao_validate_certs) }}"

          Note: KV v2 requires 'data/' in the path (kv/data/secret, not kv/secret)
