---
# Deploy backup tooling to the containers host
# Sets up an ephemeral backup container that fetches B2 credentials from
# OpenBao at runtime (no plaintext B2 creds on disk).
#
# Usage: make ansible-backup-deploy
#
# What this does:
#   1. Copies Dockerfile, scripts, paths configs to /opt/backup/
#   2. Fetches the backup-remote token from OpenBao
#   3. Writes .env with OpenBao connection params only (BAO_ADDR, BAO_TOKEN)
#   4. Builds the backup container image
#   5. Removes any legacy persistent backup container
#   6. Installs a daily cron job to run backup-remote.sh
#
# Backups run as ephemeral containers via:
#   docker compose run --rm -T backup /opt/backup/scripts/backup-remote.sh

- name: Deploy backup tooling
  hosts: container_hosts
  become: true
  gather_facts: false

  tasks:
    - name: Create backup directory structure
      ansible.builtin.file:
        path: "/opt/backup/{{ item }}"
        state: directory
        owner: deploy
        group: deploy
        mode: '0750'
      loop:
        - ""
        - logs
        - paths
        - scripts

    - name: Copy Dockerfile
      ansible.builtin.copy:
        src: /work-backup/Dockerfile
        dest: /opt/backup/Dockerfile
        owner: deploy
        group: deploy
        mode: '0644'
      register: dockerfile_result

    - name: Copy entrypoint script
      ansible.builtin.copy:
        src: /work-backup/scripts/
        dest: /opt/backup/scripts/
        owner: deploy
        group: deploy
        mode: '0755'
      register: scripts_result

    - name: Copy path configs
      ansible.builtin.copy:
        src: /work-backup/paths/
        dest: /opt/backup/paths/
        owner: deploy
        group: deploy
        mode: '0644'

    - name: Copy docker-compose file
      ansible.builtin.copy:
        src: "{{ playbook_dir }}/../files/backup/docker-compose.yml"
        dest: /opt/backup/docker-compose.yml
        owner: deploy
        group: deploy
        mode: '0644'
      register: compose_result

    # Fetch the backup-remote token from OpenBao (using Ansible's deploy token)
    - name: Retrieve backup-remote token from OpenBao
      block:
        - name: Fetch backup-remote token
          ansible.builtin.set_fact:
            backup_remote_token: "{{ lookup('community.hashi_vault.vault_kv2_get',
                                       'backup/remote-token',
                                       engine_mount_point='kv',
                                       url=openbao_addr,
                                       token=openbao_token,
                                       validate_certs=openbao_validate_certs).secret.token }}"
          no_log: true

        - name: Validate token
          ansible.builtin.assert:
            that:
              - backup_remote_token is defined
              - backup_remote_token | length > 0
            fail_msg: "Backup-remote token is empty - check kv/backup/remote-token in OpenBao"
      rescue:
        - name: Fail with helpful error
          ansible.builtin.fail:
            msg: >
              Failed to retrieve backup-remote token from OpenBao.
              Ensure BAO_TOKEN is valid and the secret exists at:
                kv/backup/remote-token (field: token)
              See backup/README.md for setup instructions.

    - name: Deploy backup environment file
      ansible.builtin.copy:
        content: |
          # Managed by Ansible - do not edit manually
          # Re-deploy with: make ansible-backup-deploy
          # The container entrypoint fetches B2/crypt credentials from OpenBao at runtime
          BAO_ADDR={{ openbao_addr }}
          BAO_TOKEN={{ backup_remote_token }}
          BAO_SKIP_VERIFY={{ 'true' if openbao_skip_verify else 'false' }}
        dest: /opt/backup/.env
        owner: deploy
        group: deploy
        mode: '0600'
      register: env_result
      no_log: true

    - name: Build backup container image
      ansible.builtin.command:
        cmd: docker compose build
        chdir: /opt/backup
      become_user: deploy
      when:
        - not ansible_check_mode
        - dockerfile_result.changed or scripts_result.changed
      register: build_result

    - name: Stop legacy persistent backup container (if present)
      ansible.builtin.command:
        cmd: docker compose down
        chdir: /opt/backup
      become_user: deploy
      when: not ansible_check_mode
      register: down_result
      changed_when: "'Removed' in down_result.stderr"

    - name: Install daily backup cron job
      ansible.builtin.cron:
        name: backup-remote-daily
        user: deploy
        hour: "3"
        minute: "0"
        job: "cd /opt/backup && docker compose run --rm -T backup /opt/backup/scripts/backup-remote.sh >> /opt/backup/logs/cron.log 2>&1"
