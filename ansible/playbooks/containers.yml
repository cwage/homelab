---
# Role ordering: NFS mounts must be in place before Docker starts
# containers that bind-mount NAS paths (/mnt/nas/Media, etc.).
# nvidia_container may restart Docker (handler) when configuring the
# NVIDIA runtime; since handlers fire after all roles but before
# play-level tasks, the compose-up below always runs with Docker ready.
- name: Configure container hosts
  hosts: container_hosts
  become: true
  gather_facts: true
  roles:
    - hostname
    - dns_client
    - users
    - packages
    - nfs_mounts
    - docker_host
    - nvidia_container

  tasks:
    - name: Mount USB backup drive
      ansible.posix.mount:
        path: /mnt/nasbak
        src: UUID=479d8cc7-5779-4707-bb19-87b555d7580b
        fstype: ext4
        opts: defaults,nofail
        state: mounted

    - name: Create stacks directory
      ansible.builtin.file:
        path: /opt/stacks
        state: directory
        owner: deploy
        group: deploy
        mode: '0755'

    - name: Create certs directory
      ansible.builtin.file:
        path: /opt/stacks/certs
        state: directory
        owner: deploy
        group: deploy
        mode: '0700'

    - name: Retrieve TLS certificates from OpenBao
      block:
        - name: Fetch TLS certificates from OpenBao
          ansible.builtin.set_fact:
            tls_certs: "{{ lookup('community.hashi_vault.vault_kv2_get',
                            'infra/certs/lan.quietlife.net',
                            engine_mount_point='kv',
                            url=openbao_addr,
                            token=openbao_token,
                            validate_certs=openbao_validate_certs).secret }}"
          no_log: true

        - name: Validate TLS certificate data
          ansible.builtin.assert:
            that:
              - tls_certs.certificate is defined
              - tls_certs.certificate | length > 0
              - tls_certs.private_key is defined
              - tls_certs.private_key | length > 0
            fail_msg: "TLS certificate or private key missing from OpenBao secret"
      rescue:
        - name: Fail with helpful error message
          ansible.builtin.fail:
            msg: >
              Failed to retrieve TLS certificates from OpenBao.
              Ensure BAO_TOKEN is valid and kv/infra/certs/lan.quietlife.net exists
              with 'certificate' and 'private_key' fields.
              Run 'make lego-store' to populate certificates.

    - name: Deploy TLS certificate
      ansible.builtin.copy:
        content: "{{ tls_certs.certificate }}"
        dest: /opt/stacks/certs/lan.quietlife.net.crt
        owner: deploy
        group: deploy
        mode: '0644'
      register: tls_cert_result
      no_log: true

    - name: Deploy TLS private key
      ansible.builtin.copy:
        content: "{{ tls_certs.private_key }}"
        dest: /opt/stacks/certs/lan.quietlife.net.key
        owner: deploy
        group: deploy
        mode: '0600'
      register: tls_key_result
      no_log: true

    - name: Copy Traefik TLS configuration
      ansible.builtin.copy:
        src: "{{ playbook_dir }}/../files/stacks/traefik-tls.yml"
        dest: /opt/stacks/traefik-tls.yml
        owner: deploy
        group: deploy
        mode: '0644'
      register: traefik_tls_result

    - name: Retrieve Cloudflare Tunnel token from OpenBao
      block:
        - name: Fetch Cloudflare Tunnel token from OpenBao
          ansible.builtin.set_fact:
            cloudflare_tunnel: "{{ lookup('community.hashi_vault.vault_kv2_get',
                              'infra/cloudflare/tunnel',
                              engine_mount_point='kv',
                              url=openbao_addr,
                              token=openbao_token,
                              validate_certs=openbao_validate_certs).secret }}"
          no_log: true
      rescue:
        - name: Warn if Cloudflare Tunnel token not found (non-fatal)
          ansible.builtin.debug:
            msg: >
              Cloudflare Tunnel token not found in OpenBao at kv/infra/cloudflare/tunnel.
              Cloudflared container will be skipped (tunnel profile disabled).
              Store token with: bao kv put kv/infra/cloudflare/tunnel token=<YOUR_TOKEN>
        - name: Set empty tunnel token
          ansible.builtin.set_fact:
            cloudflare_tunnel:
              token: ""

    - name: Determine if tunnel should be enabled
      ansible.builtin.set_fact:
        tunnel_enabled: "{{ (cloudflare_tunnel.token | default('')) | length > 0 }}"

    - name: Retrieve staticomment deploy key from OpenBao
      block:
        - name: Fetch staticomment deploy key from OpenBao
          ansible.builtin.set_fact:
            staticomment_deploy_key: "{{ lookup('community.hashi_vault.vault_kv2_get',
                              'infra/staticomment/deploy-key',
                              engine_mount_point='kv',
                              url=openbao_addr,
                              token=openbao_token,
                              validate_certs=openbao_validate_certs).secret }}"
          no_log: true
      rescue:
        - name: Warn if staticomment deploy key not found (non-fatal)
          ansible.builtin.debug:
            msg: >
              staticomment deploy key not found in OpenBao at kv/infra/staticomment/deploy-key.
              The staticomment container will not be able to push comments.
              Store key with: cat key | bao kv put kv/infra/staticomment/deploy-key private_key=-
        - name: Set empty deploy key
          ansible.builtin.set_fact:
            staticomment_deploy_key:
              private_key: ""

    - name: Create staticomment SSH directory
      ansible.builtin.file:
        path: /opt/stacks/staticomment-ssh
        state: directory
        owner: deploy
        group: deploy
        mode: '0700'
      when: (staticomment_deploy_key.private_key | default('')) | length > 0

    - name: Deploy staticomment SSH key
      ansible.builtin.copy:
        content: "{{ staticomment_deploy_key.private_key }}"
        dest: /opt/stacks/staticomment-ssh/id_ed25519
        owner: deploy
        group: deploy
        mode: '0600'
      no_log: true
      when: (staticomment_deploy_key.private_key | default('')) | length > 0

    - name: Deploy stacks environment file
      ansible.builtin.copy:
        content: |
          # Managed by Ansible - do not edit manually
          CLOUDFLARE_TUNNEL_TOKEN={{ cloudflare_tunnel.token | default('') }}
          STATICOMMENT_GIT_REPO=git@github.com:cwage/quietlife.net.git
          STATICOMMENT_BRANCH=master
          STATICOMMENT_ALLOWED_ORIGINS=https://quietlife.net
        dest: /opt/stacks/.env
        owner: deploy
        group: deploy
        mode: '0600'
      register: env_result
      no_log: true

    - name: Copy docker-compose file
      ansible.builtin.copy:
        src: "{{ playbook_dir }}/../files/stacks/docker-compose.yml"
        dest: /opt/stacks/docker-compose.yml
        owner: deploy
        group: deploy
        mode: '0644'
      register: compose_result

    # Restart containers when any config/cert/compose file changed, or when
    # force_restart is set (e.g. make ansible-containers OPTS="-e force_restart=true")
    - name: Determine if containers need restart
      ansible.builtin.set_fact:
        containers_need_restart: >-
          {{ compose_result.changed or
             traefik_tls_result.changed or
             tls_cert_result.changed or
             tls_key_result.changed or
             env_result.changed or
             (force_restart | default(false)) }}

    # Run as deploy user (in the docker group) rather than root.
    # The "tunnel" compose profile brings up cloudflared only when
    # a Cloudflare Tunnel token is present in OpenBao.
    - name: Start containers
      ansible.builtin.command:
        cmd: "docker compose {{ '--profile tunnel' if tunnel_enabled else '' }} up -d"
        chdir: /opt/stacks
      become_user: deploy
      when: containers_need_restart

    # SABnzbd hostname whitelist configuration
    # LinuxServer image doesn't support HOST_WHITELIST_ENTRIES env var,
    # so we configure it directly in sabnzbd.ini after container starts
    - name: Check if SABnzbd container is running
      ansible.builtin.command:
        cmd: docker ps -q -f name=sabnzbd
      register: sabnzbd_container_check
      changed_when: false

    - name: Wait for SABnzbd config to be created
      ansible.builtin.command:
        cmd: docker exec sabnzbd test -f /config/sabnzbd.ini
      register: sabnzbd_config_check
      retries: 10
      delay: 2
      until: sabnzbd_config_check.rc == 0
      changed_when: false
      when: sabnzbd_container_check.stdout | length > 0

    - name: Check if sabnzbd hostname is in whitelist
      ansible.builtin.command:
        cmd: docker exec sabnzbd grep -q 'sabnzbd' /config/sabnzbd.ini
      register: sabnzbd_host_check
      changed_when: false
      failed_when: false
      when: sabnzbd_container_check.stdout | length > 0

    - name: Check if sabnzbd.lan.quietlife.net is in whitelist
      ansible.builtin.command:
        cmd: docker exec sabnzbd grep -q 'sabnzbd\.lan\.quietlife\.net' /config/sabnzbd.ini
      register: sabnzbd_fqdn_check
      changed_when: false
      failed_when: false
      when: sabnzbd_container_check.stdout | length > 0

    - name: Add sabnzbd to host whitelist
      ansible.builtin.command:
        cmd: >
          docker exec sabnzbd sed -i
          's/^host_whitelist = /host_whitelist = sabnzbd,/'
          /config/sabnzbd.ini
      when:
        - sabnzbd_container_check.stdout | length > 0
        - sabnzbd_host_check.rc != 0
      register: sabnzbd_host_added

    - name: Add sabnzbd.lan.quietlife.net to host whitelist
      ansible.builtin.command:
        cmd: >
          docker exec sabnzbd sed -i
          's/^host_whitelist = /host_whitelist = sabnzbd.lan.quietlife.net,/'
          /config/sabnzbd.ini
      when:
        - sabnzbd_container_check.stdout | length > 0
        - sabnzbd_fqdn_check.rc != 0
      register: sabnzbd_fqdn_added

    - name: Restart SABnzbd to apply host whitelist
      ansible.builtin.command:
        cmd: docker restart sabnzbd
      when: (sabnzbd_host_added.changed | default(false)) or (sabnzbd_fqdn_added.changed | default(false))
