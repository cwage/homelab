---
- name: Configure container hosts
  hosts: container_hosts
  become: true
  gather_facts: true
  roles:
    - hostname
    - dns_client
    - users
    - packages
    - nfs_mounts
    - docker_host
    - nvidia_container

  tasks:
    - name: Create stacks directory
      ansible.builtin.file:
        path: /opt/stacks
        state: directory
        owner: deploy
        group: deploy
        mode: '0755'

    - name: Create certs directory
      ansible.builtin.file:
        path: /opt/stacks/certs
        state: directory
        owner: deploy
        group: deploy
        mode: '0700'

    - name: Retrieve TLS certificates from OpenBao
      block:
        - name: Fetch TLS certificates from OpenBao
          ansible.builtin.set_fact:
            tls_certs: "{{ lookup('community.hashi_vault.vault_kv2_get',
                            'infra/certs/lan.quietlife.net',
                            engine_mount_point='kv',
                            url=openbao_addr,
                            token=openbao_token,
                            validate_certs=openbao_validate_certs).secret }}"
          no_log: true

        - name: Validate TLS certificate data
          ansible.builtin.assert:
            that:
              - tls_certs.certificate is defined
              - tls_certs.certificate | length > 0
              - tls_certs.private_key is defined
              - tls_certs.private_key | length > 0
            fail_msg: "TLS certificate or private key missing from OpenBao secret"
      rescue:
        - name: Fail with helpful error message
          ansible.builtin.fail:
            msg: >
              Failed to retrieve TLS certificates from OpenBao.
              Ensure BAO_TOKEN is valid and kv/infra/certs/lan.quietlife.net exists
              with 'certificate' and 'private_key' fields.
              Run 'make lego-store' to populate certificates.

    - name: Deploy TLS certificate
      ansible.builtin.copy:
        content: "{{ tls_certs.certificate }}"
        dest: /opt/stacks/certs/lan.quietlife.net.crt
        owner: deploy
        group: deploy
        mode: '0644'
      register: tls_cert_result
      no_log: true

    - name: Deploy TLS private key
      ansible.builtin.copy:
        content: "{{ tls_certs.private_key }}"
        dest: /opt/stacks/certs/lan.quietlife.net.key
        owner: deploy
        group: deploy
        mode: '0600'
      register: tls_key_result
      no_log: true

    - name: Copy Traefik TLS configuration
      ansible.builtin.copy:
        src: "{{ playbook_dir }}/../files/stacks/traefik-tls.yml"
        dest: /opt/stacks/traefik-tls.yml
        owner: deploy
        group: deploy
        mode: '0644'
      register: traefik_tls_result

    - name: Copy docker-compose file
      ansible.builtin.copy:
        src: "{{ playbook_dir }}/../files/stacks/docker-compose.yml"
        dest: /opt/stacks/docker-compose.yml
        owner: deploy
        group: deploy
        mode: '0644'
      register: compose_result

    - name: Determine if containers need restart
      ansible.builtin.set_fact:
        containers_need_restart: >-
          {{ compose_result.changed or
             traefik_tls_result.changed or
             tls_cert_result.changed or
             tls_key_result.changed or
             (force_restart | default(false)) }}

    - name: Start containers
      ansible.builtin.command:
        cmd: docker compose up -d
        chdir: /opt/stacks
      become_user: deploy
      when: containers_need_restart
