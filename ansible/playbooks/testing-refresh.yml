---
# Restart the resume testing container to pull latest code from GitHub
# The entrypoint runs git pull on every start, so restart = fresh code.
#
# Usage: make ansible-testing-refresh
# Switch branch: make ansible-testing-switch BRANCH=master

- name: Refresh resume testing container
  hosts: container_hosts
  become: true
  gather_facts: false

  tasks:
    - name: Update branch in .env
      ansible.builtin.copy:
        content: |
          # Managed by Ansible - do not edit manually
          # Re-deploy with: make ansible-testing-deploy
          RESUME_BRANCH={{ resume_branch }}
        dest: /opt/testing/.env
        owner: deploy
        group: deploy
        mode: '0644'
      when: resume_branch is defined

    - name: Restart testing container
      ansible.builtin.command:
        cmd: docker compose restart resume-testing
        chdir: /opt/testing
      become_user: deploy
      when: not ansible_check_mode
