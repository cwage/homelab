---
# OpenBao installation and configuration

- name: Install prerequisites
  ansible.builtin.apt:
    name:
      - openssl
      - gpg
    state: present
    update_cache: true

- name: Download OpenBao deb package
  ansible.builtin.get_url:
    url: "https://github.com/openbao/openbao/releases/download/v{{ openbao_version }}/bao_{{ openbao_version }}_linux_amd64.deb"
    dest: "/tmp/bao_{{ openbao_version }}_linux_amd64.deb"
    checksum: "{{ openbao_deb_checksum }}"
    mode: "0644"

- name: Install OpenBao deb package
  ansible.builtin.apt:
    deb: "/tmp/bao_{{ openbao_version }}_linux_amd64.deb"
    state: present

- name: Ensure directories exist
  ansible.builtin.file:
    path: "{{ item }}"
    state: directory
    owner: openbao
    group: openbao
    mode: "0750"
  loop:
    - /opt/openbao/tls
    - /opt/openbao/snapshots

- name: Check if TLS certificate exists
  ansible.builtin.stat:
    path: "{{ openbao_tls_cert_file }}"
  register: tls_cert_stat

- name: Generate self-signed TLS certificate
  when: not tls_cert_stat.stat.exists
  block:
    - name: Generate private key
      ansible.builtin.command:
        cmd: >
          openssl genpkey -algorithm RSA -pkeyopt rsa_keygen_bits:4096 -out {{ openbao_tls_key_file }}
        creates: "{{ openbao_tls_key_file }}"

    - name: Generate self-signed certificate
      ansible.builtin.command:
        cmd: >
          openssl req -new -x509
          -key {{ openbao_tls_key_file }}
          -out {{ openbao_tls_cert_file }}
          -days 3650
          -subj "/CN={{ openbao_hostname }}"
          -addext "subjectAltName=DNS:{{ openbao_hostname }},DNS:{{ inventory_hostname }},IP:{{ ansible_host }}"
        creates: "{{ openbao_tls_cert_file }}"

    - name: Set TLS key permissions
      ansible.builtin.file:
        path: "{{ openbao_tls_key_file }}"
        owner: openbao
        group: openbao
        mode: "0600"

    - name: Set TLS cert permissions
      ansible.builtin.file:
        path: "{{ openbao_tls_cert_file }}"
        owner: openbao
        group: openbao
        mode: "0644"

# Deploy wildcard certificate from OpenBao (if available)
# This replaces the self-signed cert with the Let's Encrypt wildcard.
# Note: We MUST use validate_certs: false here - this is a bootstrap operation
# where OpenBao can't verify its own certificate before we deploy it.
# See docs/openbao.md for details on the TLS certificate lifecycle.
- name: Deploy wildcard TLS certificate from OpenBao
  when: openbao_deploy_wildcard_cert | default(true) | bool
  block:
    - name: Check if OpenBao is accessible and unsealed
      ansible.builtin.uri:
        url: "https://127.0.0.1:8200/v1/sys/seal-status"
        validate_certs: false
        return_content: true
      register: seal_status
      failed_when: false
      changed_when: false

    - name: Set OpenBao availability fact
      ansible.builtin.set_fact:
        openbao_available: "{{ seal_status.status | default(0) == 200 and not (seal_status.json.sealed | default(true)) }}"

    - name: Note if OpenBao is sealed or unavailable
      when: not openbao_available
      ansible.builtin.debug:
        msg: "OpenBao is sealed or unavailable - keeping existing TLS certificate"

    - name: Retrieve TLS certificates from OpenBao
      when: openbao_available
      block:
        - name: Fetch certificate from OpenBao KV
          ansible.builtin.set_fact:
            wildcard_certs: "{{ lookup('community.hashi_vault.vault_kv2_get',
                                'infra/certs/lan.quietlife.net',
                                engine_mount_point='kv',
                                url=openbao_addr,
                                token=openbao_token,
                                validate_certs=false).secret }}"
          no_log: true
      rescue:
        - name: Note certificate retrieval failed
          ansible.builtin.debug:
            msg: "Could not retrieve wildcard certificate from OpenBao - using existing cert. Run 'make lego-store' to populate."

        - name: Clear wildcard_certs on failure
          ansible.builtin.set_fact:
            wildcard_certs: {}

    - name: Deploy wildcard certificate
      when:
        - openbao_available
        - wildcard_certs is defined
        - wildcard_certs.certificate is defined
      block:
        - name: Deploy wildcard TLS certificate
          ansible.builtin.copy:
            content: "{{ wildcard_certs.certificate }}"
            dest: "{{ openbao_tls_cert_file }}"
            owner: openbao
            group: openbao
            mode: "0644"
          no_log: true
          notify: restart openbao

        - name: Deploy wildcard TLS private key
          ansible.builtin.copy:
            content: "{{ wildcard_certs.private_key }}"
            dest: "{{ openbao_tls_key_file }}"
            owner: openbao
            group: openbao
            mode: "0600"
          no_log: true
          notify: restart openbao

- name: Deploy OpenBao configuration
  ansible.builtin.template:
    src: config.hcl.j2
    dest: "{{ openbao_config_file }}"
    owner: openbao
    group: openbao
    mode: "0640"
  notify: restart openbao

- name: Enable and start OpenBao service
  ansible.builtin.systemd:
    name: openbao
    enabled: true
    state: started
    daemon_reload: true

# Backup configuration
- name: Configure OpenBao backups
  when: openbao_backup_enabled | bool
  block:
    - name: Create backup directory
      ansible.builtin.file:
        path: "{{ openbao_backup_dir }}"
        state: directory
        owner: root
        group: root
        mode: "0750"

    - name: Deploy backup script
      ansible.builtin.template:
        src: openbao-backup.sh.j2
        dest: /usr/local/bin/openbao-backup.sh
        owner: root
        group: root
        mode: "0750"

    - name: Ensure cron is installed
      ansible.builtin.apt:
        name: cron
        state: present

    - name: Install daily OpenBao backup cron job
      ansible.builtin.cron:
        name: openbao-backup-daily
        user: root
        hour: "{{ openbao_backup_schedule_hour }}"
        minute: "{{ openbao_backup_schedule_minute }}"
        job: "flock -n /var/lock/openbao-backup.lock -c '/usr/local/bin/openbao-backup.sh 2>&1 | /usr/bin/logger -t openbao-backup'"

    - name: Remove legacy systemd backup timer
      ansible.builtin.systemd:
        name: openbao-backup.timer
        enabled: false
        state: stopped
      failed_when: false

    - name: Remove legacy systemd backup units
      ansible.builtin.file:
        path: "{{ item }}"
        state: absent
      loop:
        - /etc/systemd/system/openbao-backup.service
        - /etc/systemd/system/openbao-backup.timer
      notify: reload systemd
