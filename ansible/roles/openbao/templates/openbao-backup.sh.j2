#!/bin/bash
# {{ ansible_managed }}
# OpenBao Raft snapshot backup script

set -euo pipefail

BACKUP_DIR="{{ openbao_backup_dir }}"
RETENTION_DAYS="{{ openbao_backup_retention_days }}"
TIMESTAMP=$(date +%Y%m%d-%H%M%S)
SNAPSHOT_FILE="${BACKUP_DIR}/openbao-${TIMESTAMP}.snap"

# Use localhost since we're running on the same machine
# BAO_SKIP_VERIFY is acceptable here - localhost connection with no network exposure
export BAO_ADDR="https://127.0.0.1:8200"
export BAO_SKIP_VERIFY=true

# Load backup token
TOKEN_FILE="/etc/openbao/backup-token"
if [[ -f "${TOKEN_FILE}" ]]; then
    export BAO_TOKEN="$(cat "${TOKEN_FILE}")"
else
    echo "Backup token file not found: ${TOKEN_FILE}"
    exit 1
fi

# Check if OpenBao is unsealed
# Capture output separately â€” bao status returns non-zero exit codes that
# trip pipefail even when the vault is unsealed (e.g. exit 1 with token issues)
seal_output=$(bao status 2>&1 || true)
if echo "${seal_output}" | grep -q "Sealed.*false"; then
    :
elif echo "${seal_output}" | grep -q "Sealed.*true"; then
    echo "OpenBao is sealed, skipping backup"
    exit 0
else
    echo "Failed to determine OpenBao seal status, aborting. bao status output:"
    echo "${seal_output}"
    exit 1
fi

# Create backup directory if it doesn't exist (with secure permissions)
mkdir -p "${BACKUP_DIR}"
chmod 0750 "${BACKUP_DIR}"

# Take Raft snapshot
echo "Taking Raft snapshot to ${SNAPSHOT_FILE}"
bao operator raft snapshot save "${SNAPSHOT_FILE}"

# Clean up old backups
echo "Removing backups older than ${RETENTION_DAYS} days"
find "${BACKUP_DIR}" -name "openbao-*.snap" -type f -mtime +${RETENTION_DAYS} -delete

echo "Backup completed successfully"
