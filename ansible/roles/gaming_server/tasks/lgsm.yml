---
# Install LinuxGSM for a game server profile
# Each profile gets its own LGSM installation in the profile user's home directory

- name: "Set LGSM script name for {{ profile.name }}"
  ansible.builtin.set_fact:
    lgsm_script: "{{ lgsm_script_names[profile.game] | default(profile.game + 'server') }}"

- name: "Download LGSM installer for {{ profile.name }}"
  ansible.builtin.get_url:
    url: "{{ lgsm_url }}"
    dest: "/home/{{ profile.name }}/linuxgsm.sh"
    mode: "0755"
    owner: "{{ profile.name }}"
    group: "{{ profile.name }}"
    checksum: "{{ lgsm_installer_checksum | default(omit) }}"

- name: "Check if LGSM script exists for {{ profile.name }}"
  ansible.builtin.stat:
    path: "/home/{{ profile.name }}/{{ lgsm_script }}"
  register: lgsm_script_stat

- name: "Install LGSM for {{ profile.name }}"
  ansible.builtin.command:
    cmd: "./linuxgsm.sh {{ lgsm_script }}"
    chdir: "/home/{{ profile.name }}"
    creates: "/home/{{ profile.name }}/{{ lgsm_script }}"
  become: true
  become_user: "{{ profile.name }}"
  when: not lgsm_script_stat.stat.exists

# Check for game executable to determine if game is installed
# serverfiles/ may exist from LGSM setup but be empty until game is installed
- name: "Check if game is installed for {{ profile.name }}"
  ansible.builtin.stat:
    path: "/home/{{ profile.name }}/serverfiles/{{ lgsm_game_executables[profile.game] }}"
  register: game_executable

- name: "Install game via LGSM for {{ profile.name }}"
  ansible.builtin.command:
    cmd: "./{{ lgsm_script }} auto-install"
    chdir: "/home/{{ profile.name }}"
  become: true
  become_user: "{{ profile.name }}"
  when: not game_executable.stat.exists
  register: game_install_result

# Track fresh installs so we can start the server after configs are deployed
- name: "Mark fresh install for {{ profile.name }}"
  ansible.builtin.set_fact:
    fresh_installs: "{{ fresh_installs | default({}) | combine({profile.name: true}) }}"
  when: game_install_result is defined and game_install_result is changed
