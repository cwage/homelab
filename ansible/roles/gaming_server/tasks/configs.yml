---
# Deploy configuration files for a game server profile
# Configs are deployed but servers are NEVER restarted automatically

- name: "Set config paths for {{ profile.name }}"
  ansible.builtin.set_fact:
    profile_config_src: "{{ gaming_profiles_dir }}/{{ profile.name }}"
    profile_config_dest: "/home/{{ profile.name }}"
    lgsm_script: "{{ lgsm_script_names[profile.game] | default(profile.game + 'server') }}"

- name: "Check if profile config directory exists for {{ profile.name }}"
  ansible.builtin.stat:
    path: "{{ profile_config_src }}"
  delegate_to: localhost
  become: false
  register: profile_config_dir

- name: "Skip config deployment if no config directory for {{ profile.name }}"
  ansible.builtin.debug:
    msg: "No config directory found at {{ profile_config_src }} - skipping config deployment"
  when: not profile_config_dir.stat.exists

# Fetch password from OpenBao (required)
- name: "Fetch password from OpenBao for {{ profile.name }}"
  ansible.builtin.set_fact:
    profile_password: "{{ lookup('community.hashi_vault.vault_kv2_get',
                          'services/gaming/' + profile.name,
                          engine_mount_point='kv',
                          url=openbao_addr,
                          token=openbao_token,
                          validate_certs=openbao_validate_certs).secret.password }}"
  no_log: true

# Vintage Story specific config deployment
- name: "Deploy Vintage Story configs for {{ profile.name }}"
  when: profile.game == 'vintagestory'
  block:
    - name: "Ensure serverfiles/data/{{ lgsm_script }} directory exists for {{ profile.name }}"
      ansible.builtin.file:
        path: "{{ profile_config_dest }}/serverfiles/data/{{ lgsm_script }}"
        state: directory
        owner: "{{ profile.name }}"
        group: "{{ profile.name }}"
        mode: "0755"

    - name: "Deploy serverconfig.json from template for {{ profile.name }}"
      ansible.builtin.template:
        src: "vintagestory/serverconfig.json.j2"
        dest: "{{ profile_config_dest }}/serverfiles/data/{{ lgsm_script }}/serverconfig.json"
        owner: "{{ profile.name }}"
        group: "{{ profile.name }}"
        mode: "0644"
      register: serverconfig_changed

    # Mods and ModConfig are still deployed from static files per-profile
    - name: "Check for mods directory for {{ profile.name }}"
      ansible.builtin.stat:
        path: "{{ profile_config_src }}/mods"
      delegate_to: localhost
      become: false
      register: mods_dir
      when: profile_config_dir.stat.exists

    - name: "Ensure Mods directory exists for {{ profile.name }}"
      ansible.builtin.file:
        path: "{{ profile_config_dest }}/serverfiles/data/{{ lgsm_script }}/Mods"
        state: directory
        owner: "{{ profile.name }}"
        group: "{{ profile.name }}"
        mode: "0755"
      when: profile_config_dir.stat.exists and mods_dir.stat.exists

    - name: "Deploy mods for {{ profile.name }}"
      ansible.builtin.copy:
        src: "{{ profile_config_src }}/mods/"
        dest: "{{ profile_config_dest }}/serverfiles/data/{{ lgsm_script }}/Mods/"
        owner: "{{ profile.name }}"
        group: "{{ profile.name }}"
        mode: "0644"
      when: profile_config_dir.stat.exists and mods_dir.stat.exists
      register: mods_changed

    - name: "Check for modconfig directory for {{ profile.name }}"
      ansible.builtin.stat:
        path: "{{ profile_config_src }}/modconfig"
      delegate_to: localhost
      become: false
      register: modconfig_dir
      when: profile_config_dir.stat.exists

    - name: "Ensure ModConfig directory exists for {{ profile.name }}"
      ansible.builtin.file:
        path: "{{ profile_config_dest }}/serverfiles/data/{{ lgsm_script }}/ModConfig"
        state: directory
        owner: "{{ profile.name }}"
        group: "{{ profile.name }}"
        mode: "0755"
      when: profile_config_dir.stat.exists and modconfig_dir.stat.exists

    - name: "Deploy mod configs for {{ profile.name }}"
      ansible.builtin.copy:
        src: "{{ profile_config_src }}/modconfig/"
        dest: "{{ profile_config_dest }}/serverfiles/data/{{ lgsm_script }}/ModConfig/"
        owner: "{{ profile.name }}"
        group: "{{ profile.name }}"
        mode: "0644"
        directory_mode: "0755"
      when: profile_config_dir.stat.exists and modconfig_dir.stat.exists
      register: modconfig_changed

# Start server after fresh install (configs are now in place)
- name: "Start game server after fresh install for {{ profile.name }}"
  ansible.builtin.command:
    cmd: "./{{ lgsm_script }} start"
    chdir: "{{ profile_config_dest }}"
  become: true
  become_user: "{{ profile.name }}"
  when: fresh_installs is defined and fresh_installs[profile.name] | default(false)
  register: game_start_result

- name: "Show fresh install result for {{ profile.name }}"
  ansible.builtin.debug:
    msg: "Game installed, configured, and started successfully for {{ profile.name }}"
  when: fresh_installs is defined and fresh_installs[profile.name] | default(false)

# Reminder message - never auto-restart (only shown for config updates, not fresh installs)
- name: "Config deployment reminder for {{ profile.name }}"
  ansible.builtin.debug:
    msg:
      - "Config/mods updated for {{ profile.name }}. To apply changes:"
      - "  ssh {{ inventory_hostname }}"
      - "  sudo -iu {{ profile.name }}"
      - "  ./{{ lgsm_script }} restart"
  when: >-
    (not (fresh_installs is defined and fresh_installs[profile.name] | default(false))) and
    ((serverconfig_changed is defined and serverconfig_changed.changed) or
    (mods_changed is defined and mods_changed.changed) or
    (modconfig_changed is defined and modconfig_changed.changed))
