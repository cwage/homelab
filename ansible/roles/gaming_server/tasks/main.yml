---
# Gaming server role - main entry point
#
# This role manages game server profiles using LinuxGSM.
# Each profile gets its own Linux user (no sudo) with isolated game installation.
#
# Ansible provisions, LGSM runs, user controls restarts.
# Servers are NEVER automatically restarted by Ansible.

- name: Filter active profiles
  ansible.builtin.set_fact:
    active_profiles: "{{ gaming_profiles | selectattr('active', 'defined') | selectattr('active', 'equalto', true) | list + gaming_profiles | rejectattr('active', 'defined') | list }}"
  when: gaming_profile_filter is not defined
  tags: always

- name: Filter to specific profile
  ansible.builtin.set_fact:
    active_profiles: "{{ gaming_profiles | selectattr('name', 'equalto', gaming_profile_filter) | list }}"
  when: gaming_profile_filter is defined
  tags: always

- name: Validate requested gaming profile exists
  ansible.builtin.fail:
    msg: >-
      gaming_profile_filter '{{ gaming_profile_filter }}' does not match any
      defined gaming_profiles. Available profiles:
      {{ gaming_profiles | map(attribute='name') | list | join(', ') }}
  when:
    - gaming_profile_filter is defined
    - active_profiles | length == 0
  tags: always

- name: Validate requested gaming profile is active
  ansible.builtin.fail:
    msg: >-
      Profile '{{ gaming_profile_filter }}' has active: false. Set active: true
      in group_vars/gaming_servers.yml before provisioning.
  when:
    - gaming_profile_filter is defined
    - active_profiles | length > 0
    - not (active_profiles[0].active | default(true))
  tags: always

- name: Display profiles to be managed
  ansible.builtin.debug:
    msg: "Managing profiles: {{ active_profiles | map(attribute='name') | list }}"
  tags: always

- name: Include profile user tasks
  ansible.builtin.include_tasks:
    file: user.yml
    apply:
      tags:
        - users
        - provision
  loop: "{{ active_profiles }}"
  loop_control:
    loop_var: profile
  tags:
    - users
    - provision

- name: Include dependency tasks
  ansible.builtin.include_tasks:
    file: dependencies.yml
    apply:
      tags:
        - dependencies
        - provision
  tags:
    - dependencies
    - provision

- name: Include LGSM tasks
  ansible.builtin.include_tasks:
    file: lgsm.yml
    apply:
      tags:
        - lgsm
        - provision
  loop: "{{ active_profiles }}"
  loop_control:
    loop_var: profile
  tags:
    - lgsm
    - provision

- name: Include config deployment tasks
  ansible.builtin.include_tasks:
    file: configs.yml
    apply:
      tags:
        - configs
  loop: "{{ active_profiles }}"
  loop_control:
    loop_var: profile
  tags:
    - configs

- name: Include mod deployment tasks
  ansible.builtin.include_tasks:
    file: mods.yml
    apply:
      tags:
        - mods
        - configs
  loop: "{{ active_profiles }}"
  loop_control:
    loop_var: profile
  tags:
    - mods
    - configs

- name: Include cron tasks
  ansible.builtin.include_tasks:
    file: cron.yml
    apply:
      tags:
        - cron
        - provision
  loop: "{{ active_profiles }}"
  loop_control:
    loop_var: profile
  tags:
    - cron
    - provision
