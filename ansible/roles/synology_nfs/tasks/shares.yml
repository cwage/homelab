---
# NFS share management tasks

- name: Check if NFS service is running
  ansible.builtin.raw: systemctl is-active nfs-server
  become: true
  register: nfs_service_status
  changed_when: false
  check_mode: false
  failed_when: false

- name: Enable and start NFS service
  ansible.builtin.raw: systemctl enable --now nfs-server
  become: true
  when:
    - nfs_enable | bool
    - nfs_service_status.rc != 0
  notify: Restart NFS service

- name: Check and create NFS shares
  ansible.builtin.raw: |
    if ! /usr/syno/sbin/synoshare --get {{ item.name }} >/dev/null 2>&1; then
      /usr/syno/sbin/synoshare --add {{ item.name }} "{{ item.description }}" {{ item.path }} "" "" "" 1 0
      echo "SHARE_CREATED"
    fi
  become: true
  register: share_creation
  changed_when: "'SHARE_CREATED' in share_creation.stdout"
  loop: "{{ nfs_shares }}"
  loop_control:
    label: "{{ item.name }}"
  when:
    - nfs_shares | length > 0
    - item.nfs_enabled | default(true)

- name: Build NFS export entries
  ansible.builtin.set_fact:
    nfs_export_lines: |
      {% for share in nfs_shares %}
      {% for rule in share.nfs_rules %}
      {{ share.path }}  {{ rule.host }}({{ rule.privilege }},async,no_wdelay,{{ rule.squash }},insecure_locks,sec={{ rule.security }},anonuid={{ rule.anonuid | default(share.anonuid | default(nfs_default_anonuid)) }},anongid={{ rule.anongid | default(share.anongid | default(nfs_default_anongid)) }})
      {% endfor %}
      {% endfor %}
  when: nfs_shares | length > 0

- name: Manage Ansible-controlled section in /etc/exports
  ansible.builtin.raw: |
    cat > /tmp/exports_block << 'EXPORTS_EOF'

    # BEGIN ANSIBLE MANAGED BLOCK - portanas NFS exports
    # WARNING: This section is managed by Ansible. Manual edits will be lost.
    # Last updated: $(date -Iseconds)
    {{ nfs_export_lines }}
    # END ANSIBLE MANAGED BLOCK
    EXPORTS_EOF

    # Remove old Ansible block if it exists (including any preceding blank line)
    sed -i '/^$/N;/\n# BEGIN ANSIBLE MANAGED BLOCK/,/# END ANSIBLE MANAGED BLOCK/d' /etc/exports

    # Also remove simple block match in case the blank line pattern didn't match
    sed -i '/# BEGIN ANSIBLE MANAGED BLOCK/,/# END ANSIBLE MANAGED BLOCK/d' /etc/exports

    # Append new block
    cat /tmp/exports_block >> /etc/exports

    # Cleanup
    rm /tmp/exports_block
  become: true
  when: nfs_shares | length > 0
  notify: Reload NFS exports

- name: Display configuration status
  ansible.builtin.debug:
    msg: "Configured {{ nfs_shares | length }} NFS share(s)"
  when: nfs_shares | length > 0
