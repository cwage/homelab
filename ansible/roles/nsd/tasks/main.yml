---
- name: Disable systemd-resolved (conflicts with NSD on port 53)
  ansible.builtin.systemd:
    name: systemd-resolved
    enabled: false
    state: stopped

# NSD is authoritative-only (no recursion). Point the DNS server's own
# resolv.conf at fw1/Unbound for recursive lookups (apt, etc.).
- name: Configure static resolv.conf
  ansible.builtin.copy:
    content: |
      # Managed by Ansible - static DNS config for NSD server
      nameserver 10.10.15.1
      search lan.quietlife.net
    dest: /etc/resolv.conf
    owner: root
    group: root
    mode: "0644"

- name: Install NSD
  ansible.builtin.apt:
    name: nsd
    state: present
    update_cache: true

# Ansible runs the validate command before placing each file. If validation
# fails, the file is not deployed and the play errors out safely.
- name: Create NSD configuration
  ansible.builtin.template:
    src: nsd.conf.j2
    dest: /etc/nsd/nsd.conf
    owner: root
    group: nsd
    mode: "0640"
    validate: "nsd-checkconf %s"
  notify: Restart NSD

- name: Create forward zone file
  ansible.builtin.template:
    src: lan.quietlife.net.zone.j2
    dest: "{{ nsd_zones_dir }}/lan.quietlife.net.zone"
    owner: root
    group: nsd
    mode: "0644"
    validate: "nsd-checkzone lan.quietlife.net %s"
  notify: Reload NSD

- name: Create reverse zone file
  ansible.builtin.template:
    src: 15.10.10.in-addr.arpa.zone.j2
    dest: "{{ nsd_zones_dir }}/15.10.10.in-addr.arpa.zone"
    owner: root
    group: nsd
    mode: "0644"
    validate: "nsd-checkzone 15.10.10.in-addr.arpa %s"
  notify: Reload NSD

- name: Check if NSD is installed
  ansible.builtin.stat:
    path: /usr/sbin/nsd
  register: nsd_binary

- name: Ensure NSD is enabled and running
  ansible.builtin.systemd:
    name: nsd
    enabled: true
    state: started
  when: nsd_binary.stat.exists
