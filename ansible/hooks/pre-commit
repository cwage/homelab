#!/usr/bin/env bash
set -euo pipefail

if [[ "${SKIP_TRUFFLEHOG:-}" == "1" ]]; then
  exit 0
fi

repo_root=$(git rev-parse --show-toplevel)
cd "$repo_root"

compose_cmd=(docker compose)
if ! docker compose version >/dev/null 2>&1; then
  if command -v docker-compose >/dev/null 2>&1; then
    compose_cmd=(docker-compose)
  else
    echo "docker compose plugin is required to run the TruffleHog hook." >&2
    exit 1
  fi
fi

if [[ ! -f docker-compose.yml ]]; then
  echo "docker-compose.yml not found in repo root ($repo_root)." >&2
  exit 1
fi

if [[ -n "${TRUFFLEHOG_PRECOMMIT_ARGS:-}" ]]; then
  # shellcheck disable=SC2206
  args=( ${TRUFFLEHOG_PRECOMMIT_ARGS} )
else
  args=(filesystem /work --fail --no-update --exclude-paths /work/.trufflehog-exclude.txt)
fi

>&2 echo "Running TruffleHog pre-commit scan..."
NO_COLOR=1 "${compose_cmd[@]}" run --rm -T trufflehog "${args[@]}"
