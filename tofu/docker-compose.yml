services:
  tofu:
    build:
      context: .
      dockerfile: Dockerfile
    image: homelab-tofu:latest
    container_name: homelab-tofu
    working_dir: /workspace/tofu
    volumes:
      # Mount the entire project directory
      - ..:/workspace
      # Preserve SSH keys for git operations if needed
      - ${HOME}/.ssh:/home/tofu/.ssh:ro
    environment:
      # Proxmox API credentials - TF_VAR_ prefix maps to OpenTofu variables
      - TF_VAR_pm_api_url=${PM_API_URL}
      - TF_VAR_pm_api_token_id=${PM_API_TOKEN_ID}
      - TF_VAR_pm_api_token_secret=${PM_API_TOKEN_SECRET}
      - TF_VAR_pm_node_name=${PM_NODE_NAME}
      - TF_VAR_pm_image_datastore_id=${PM_IMAGE_DATASTORE_ID:-local}
      - TF_VAR_pm_vm_datastore_id=${PM_VM_DATASTORE_ID:-local-lvm}
      # OpenBao credentials for secret retrieval
      - BAO_ADDR=${BAO_ADDR:-}
      - BAO_TOKEN=${BAO_TOKEN:-}
      - BAO_SKIP_VERIFY=${BAO_SKIP_VERIFY:-}
      # Disable OpenTofu telemetry
      - TF_CLI_ARGS=-no-color
    # Keep container running for interactive use
    stdin_open: true
    tty: true
